@model StudentFreelance.ViewModels.ReportDetailViewModel

@{
    ViewData["Title"] = "Chi tiết báo cáo";
    Layout = "_Dashboard";
}

@section Styles {
    <link rel="stylesheet" href="~/css/report/listReport.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
}

<div class="container-fluid">
    <div class="topbar">
        <h1><i class="fas fa-flag"></i> Chi tiết báo cáo #@Model.ReportID</h1>
        
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Trang chủ</a></li>
                @if (User.IsInRole("Admin") || User.IsInRole("Moderator"))
                {
                    <li class="breadcrumb-item"><a href="@Url.Action("ListReport", "Report")">Danh sách báo cáo</a></li>
                }
                <li class="breadcrumb-item active">Chi tiết báo cáo #@Model.ReportID</li>
            </ol>
        </nav>

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i> @TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i> @TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="table-container mb-4">
                <h4 class="card-header mb-4">Thông tin chung</h4>
                <div class="detail-row">
                    <div class="detail-label">Mã báo cáo:</div>
                    <div class="detail-value">@Model.ReportID</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Ngày báo cáo:</div>
                    <div class="detail-value">@Model.ReportDate.ToString("dd/MM/yyyy HH:mm")</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Loại báo cáo:</div>
                    <div class="detail-value">@Model.TypeName</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Trạng thái:</div>
                    <div class="detail-value">
                        @if (Model.StatusName == "Đang xử lý")
                        {
                            <span class="status-pending">@Model.StatusName</span>
                        }
                        else if (Model.StatusName == "Đã xử lý")
                        {
                            <span class="status-active">@Model.StatusName</span>
                        }
                        else if (Model.StatusName == "Đã hủy")
                        {
                            <span class="status-inactive">@Model.StatusName</span>
                        }
                        else
                        {
                            <span class="badge @(Model.StatusName == "Đang xử lý" ? "bg-warning" : 
                                               Model.StatusName == "Đã xử lý" ? "bg-success" : 
                                               Model.StatusName == "Đã hủy" ? "bg-danger" : "bg-secondary")">
                                @Model.StatusName
                            </span>
                        }
                    </div>
                </div>
                @if (Model.ResolvedAt.HasValue)
                {
                    <div class="detail-row">
                        <div class="detail-label">Ngày xử lý:</div>
                        <div class="detail-value">@Model.ResolvedAt.Value.ToString("dd/MM/yyyy HH:mm")</div>
                    </div>
                }
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="table-container mb-4">
                <h4 class="card-header mb-4">Thông tin liên quan</h4>
                <div class="detail-row">
                    <div class="detail-label">Người báo cáo:</div>
                    <div class="detail-value">@Model.ReporterName</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Người bị báo cáo:</div>
                    <div class="detail-value">@Model.ReportedUserName</div>
                </div>
                @if (!string.IsNullOrEmpty(Model.ProjectTitle) && Model.ProjectTitle != "Không có dự án")
                {
                    <div class="detail-row">
                        <div class="detail-label">Dự án:</div>
                        <div class="detail-value">
                            @Model.ProjectTitle
                            @if (User.IsInRole("Admin") || User.IsInRole("Moderator"))
                            {
                                <a href="@Url.Action("Details", "Project", new { id = Model.ProjectID })" class="action-btn edit">
                                    <i class="fas fa-eye"></i> Xem dự án
                                </a>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="table-container mb-4">
        <h4 class="card-header mb-4">Nội dung báo cáo</h4>
        <div class="report-content">
            @Model.Description
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.AdminResponse))
    {
        <div class="table-container mb-4">
            <h4 class="card-header mb-4">Phản hồi từ quản trị viên</h4>
            <div class="admin-response">
                @Model.AdminResponse
            </div>
        </div>
    }

    @if (User.IsInRole("Admin") || User.IsInRole("Moderator"))
    {
        <div class="table-container mb-4">
            <h4 class="card-header mb-4">Cập nhật trạng thái</h4>
            <form asp-action="UpdateStatus" method="post" class="needs-validation" novalidate>
                @Html.AntiForgeryToken()
                <input type="hidden" name="reportId" value="@Model.ReportID" />
                
                <div class="detail-row">
                    <div class="detail-label">Trạng thái mới:</div>
                    <div class="detail-value">
                        <select name="statusId" class="form-select" required>
                            <option value="">-- Chọn trạng thái --</option>
                            @if (ViewBag.ReportStatuses != null)
                            {
                                @foreach (var status in ViewBag.ReportStatuses)
                                {
                                    if (status.Selected)
                                    {
                                        <option value="@status.Value" selected>@status.Text</option>
                                    }
                                    else
                                    {
                                        <option value="@status.Value">@status.Text</option>
                                    }
                                }
                            }
                            else
                            {
                                if (Model.StatusName == "Đang xử lý")
                                {
                                    <option value="1" selected>Đang xử lý</option>
                                }
                                else
                                {
                                    <option value="1">Đang xử lý</option>
                                }
                                
                                if (Model.StatusName == "Đã xử lý")
                                {
                                    <option value="2" selected>Đã xử lý</option>
                                }
                                else
                                {
                                    <option value="2">Đã xử lý</option>
                                }
                                
                                if (Model.StatusName == "Đã hủy")
                                {
                                    <option value="3" selected>Đã hủy</option>
                                }
                                else
                                {
                                    <option value="3">Đã hủy</option>
                                }
                            }
                        </select>
                        <div class="invalid-feedback">Vui lòng chọn trạng thái</div>
                    </div>
                </div>
                
                <div class="detail-row">
                    <div class="detail-label">Phản hồi:</div>
                    <div class="detail-value">
                        <textarea name="adminResponse" class="form-control" rows="4" placeholder="Nhập phản hồi của bạn (không bắt buộc)">@Model.AdminResponse</textarea>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button type="submit" class="filter-btn" id="updateStatusBtn">
                        <i class="fas fa-check-circle"></i> Cập nhật trạng thái
                    </button>
                    
                    <a asp-action="ListReport" class="action-btn edit">
                        <i class="fas fa-arrow-left"></i> Quay lại danh sách
                    </a>
                </div>
            </form>
        </div>
    }
    else
    {
        <div class="action-buttons">
            <a asp-controller="Home" asp-action="Index" class="action-btn edit">
                <i class="fas fa-arrow-left"></i> Quay lại trang chủ
            </a>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Ensure form validation
        (function() {
            'use strict';
            
            // Fetch all forms we want to apply validation to
            var forms = document.querySelectorAll('form');
            
            // Loop over them and prevent submission if validation fails
            Array.prototype.slice.call(forms).forEach(function(form) {
                form.addEventListener('submit', function(event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    } else {
                        // If form is valid, check if it's the status update form
                        if (form.getAttribute('action').includes('UpdateStatus')) {
                            // Show confirmation dialog
                            if (!confirm('Bạn có chắc chắn muốn cập nhật trạng thái báo cáo này?')) {
                                event.preventDefault();
                                return false;
                            }
                        }
                    }
                    
                    form.classList.add('was-validated');
                }, false);
            });
        })();
        
        // Auto-dismiss alerts after 5 seconds
        setTimeout(function() {
            var alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                var bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);
    </script>
} 