@model IEnumerable<StudentFreelance.Models.ApplicationUser>
@{
    ViewData["Title"] = "T√¨m ki·∫øm doanh nghi·ªáp";
}

@section Styles {
    <link rel="stylesheet" href="~/css/search/searchBusinesses.css" asp-append-version="true" />
}

<div class="container my-5 search-businesses-container">
    <div class="topbar">
        <h1><i class="bi bi-search"></i> T√¨m ki·∫øm doanh nghi·ªáp</h1>
        
        <form asp-action="SearchBusinesses" method="get" class="filter-row">
            <div class="filter-group">
                <input type="text" name="query" value="@ViewBag.Query" placeholder="üîç T√¨m ki·∫øm doanh nghi·ªáp..." />
            </div>
            
            <div class="filter-group">
                <select name="provinceCode" class="custom-select">
                    <option value="">üìç T·∫•t c·∫£ t·ªânh/th√†nh</option>
                    @foreach (var province in ViewBag.Provinces)
                    {
                        var selected = ViewBag.ProvinceCode != null && ViewBag.ProvinceCode == province.ID;
                        <option value="@province.ID" selected="@selected">
                            @province.Name
                        </option>
                    }
                </select>
            </div>
            
            <button type="submit" class="filter-btn">
                <i class="bi bi-filter"></i> T√¨m ki·∫øm
            </button>
            
            <a href="@Url.Action("SearchBusinesses", "Search")" class="reset-btn">
                <i class="bi bi-x-circle"></i> X√≥a b·ªô l·ªçc
            </a>
        </form>
    </div>

    <div class="row business-list mt-4">
        @if (Model.Any())
        {
            foreach (var business in Model)
            {
                <div class="col-md-12 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-2 text-center">
                                    @if (!string.IsNullOrEmpty(business.ProfilePicturePath))
                                    {
                                        <img src="@business.ProfilePicturePath" class="img-fluid rounded-circle mb-2" style="width: 100px; height: 100px; object-fit: cover;" alt="@business.CompanyName">
                                    }
                                    else
                                    {
                                        <div class="profile-avatar-placeholder mb-2">
                                            <span>@(business.CompanyName?.Substring(0, 1) ?? "C")</span>
                                        </div>
                                    }
                                </div>
                                <div class="col-md-7">
                                    <h5 class="business-name">
                                        @business.CompanyName
                                    </h5>
                                    <p class="text-muted mb-2">@business.Industry</p>
                                    
                                    <div class="mb-2">
                                        <div><i class="bi bi-person-fill me-2"></i>@business.FullName</div>
                                        
                                        @if (business.Address != null && (!string.IsNullOrEmpty(business.Address.ProvinceName) || !string.IsNullOrEmpty(business.Address.DetailAddress)))
                                        {
                                            <div>
                                                <i class="bi bi-geo-alt-fill me-2"></i>
                                                <span>
                                                    @if (!string.IsNullOrEmpty(business.Address.DetailAddress))
                                                    {
                                                        @(business.Address.DetailAddress)<text>, </text>
                                                    }
                                                    @if (!string.IsNullOrEmpty(business.Address.WardName))
                                                    {
                                                        @(business.Address.WardName)<text>, </text>
                                                    }
                                                    @if (!string.IsNullOrEmpty(business.Address.DistrictName))
                                                    {
                                                        @(business.Address.DistrictName)<text>, </text>
                                                    }
                                                    @if (!string.IsNullOrEmpty(business.Address.ProvinceName))
                                                    {
                                                        @(business.Address.ProvinceName)
                                                    }
                                                </span>
                                            </div>
                                        }
                                        else
                                        {
                                            <div><i class="bi bi-geo-alt-fill me-2"></i>Ch∆∞a c√≥ th√¥ng tin ƒë·ªãa ch·ªâ</div>
                                        }
                                        
                                        @if (!string.IsNullOrEmpty(business.PhoneNumber))
                                        {
                                            <div><i class="bi bi-telephone-fill me-2"></i>@business.PhoneNumber</div>
                                        }
                                        <div><i class="bi bi-envelope-fill me-2"></i>@business.Email</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="info-badge rating-badge me-2">
                                            <i class="bi bi-star-fill me-1"></i>
                                            @business.AverageRating
                                        </div>
                                        <div class="info-badge project-badge">
                                            <i class="bi bi-briefcase-fill me-1"></i>
                                            @(ViewBag.ProjectCounts != null && ViewBag.ProjectCounts.ContainsKey(business.Id) 
                                                ? ViewBag.ProjectCounts[business.Id] 
                                                : 0) d·ª± √°n
                                        </div>
                                        @if (business.IsVerified)
                                        {
                                            <div class="verified-badge">
                                                <i class="fas fa-check-circle me-1"></i>
                                                <span>Verified</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="col-md-3 d-flex align-items-center justify-content-center">
                                    <a href="@Url.Action("Profile", "User", new { id = business.Id })" class="btn btn-view-profile btn-lg">
                                        <i class="bi bi-person-badge me-1"></i>Xem h·ªì s∆°
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
            
            @if (ViewBag.TotalPages != null && ViewBag.CurrentPage != null)
            {
                var paginationModel = new StudentFreelance.ViewModels.PaginationViewModel
                {
                    TotalPages = (int)ViewBag.TotalPages,
                    CurrentPage = (int)ViewBag.CurrentPage,
                    TotalRecords = (int)ViewBag.TotalRecords,
                    ActionName = "SearchBusinesses",
                    ControllerName = "Search",
                    ItemName = "doanh nghi·ªáp",
                    RouteValues = new Dictionary<string, string>
                    {
                        ["query"] = ViewBag.Query?.ToString() ?? string.Empty,
                        ["provinceCode"] = ViewBag.ProvinceCode?.ToString() ?? string.Empty
                    }
                };
                
                <partial name="_Pagination" model="paginationModel" />
            }
        }
        else
        {
            <div class="col-12">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Kh√¥ng t√¨m th·∫•y doanh nghi·ªáp n√†o ph√π h·ª£p v·ªõi ti√™u ch√≠ t√¨m ki·∫øm.
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('select[name="provinceCode"]').select2({
                placeholder: "üìç T·∫•t c·∫£ t·ªânh/th√†nh",
                allowClear: true,
                dropdownCssClass: 'province-dropdown',
                width: '100%'
            }).on('select2:open', function() {
                // ƒê·∫£m b·∫£o dropdown hi·ªÉn th·ªã ƒë√∫ng v·ªã tr√≠ v√† z-index
                setTimeout(function() {
                    $('.province-dropdown').parent().css('z-index', '10000');
                }, 0);
            });
            
            // ƒê·∫£m b·∫£o dropdown lu√¥n hi·ªÉn th·ªã ph√≠a tr√™n khi cu·ªôn trang
            $(window).on('scroll resize', function() {
                var openDropdown = $(".select2-container--open");
                if (openDropdown.length) {
                    openDropdown.css({
                        'z-index': '10000',
                        'position': 'absolute'
                    });
                }
            });
            
            // S·ª≠a l·ªói click b·ªã double
            $('span.select2').on('click', function(e) {
                // NgƒÉn s·ª± ki·ªán click lan truy·ªÅn ƒë·∫øn c√°c ph·∫ßn t·ª≠ cha
                e.stopPropagation();
            });
        });
    </script>
} 