@model IEnumerable<StudentFreelance.Models.Notification>

<link rel="stylesheet" href="~/css/notification/index.css" asp-append-version="true" />

@{
    ViewData["Title"] = "Thông báo của tôi";

    if (User.IsInRole("Admin"))
    {
        Layout = "~/Views/Shared/_Dashboard.cshtml";
    }
    else
    {
        Layout = "~/Views/Shared/_Layout.cshtml";
    }
}

<div class="notification-container">
    <h2 class="notification-title">🔔 Thông báo của bạn</h2>

    @if (!Model.Any())
    {
        <div class="alert-info">Bạn chưa có thông báo nào.</div>
    }
    else
    {
        <div class="notification-actions">
            <a href="#" class="btn-mark-all" onclick="markAllAsRead(); return false;">✔ Đánh dấu tất cả là đã đọc</a>

            @if (User.IsInRole("Admin"))
            {
                <a asp-action="Send" class="btn-send-notification">+ Gửi thông báo</a>
            }
        </div>


        <ul class="notification-list">
            @foreach (var item in Model)
            {
                var userNotification = item.UserNotifications.FirstOrDefault();
                var isRead = userNotification?.IsRead ?? false;

                <li class="notification-item @(isRead ? "" : "unread")">
                    <div>
                        <div class="fw-bold">
                            <a asp-action="Details" asp-route-id="@item.NotificationID">
                                @item.Title
                            </a>
                        </div>
                        <div class="notification-meta">
                            📅 @item.NotificationDate.ToString("dd/MM/yyyy HH:mm")
                            | 👤 @(item.Sender?.FullName ?? "Hệ thống")
                            | 🏷️ @item.Type?.TypeName
                        </div>
                    </div>

                    @if (!isRead)
                    {
                        <form asp-action="MarkAsRead" method="post" asp-route-id="@item.NotificationID">
                            <button class="btn-mark-read">✔ Đã đọc</button>
                        </form>
                    }
                </li>
            }
        </ul>
    }
</div>

<script>
function markAllAsRead() {
    if (confirm('Bạn có chắc muốn đánh dấu tất cả thông báo là đã đọc?')) {
        fetch('@Url.Action("MarkAllAsRead", "Notification")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
}
</script>
