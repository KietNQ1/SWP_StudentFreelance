@model StudentFreelance.ViewModels.UserProfileViewModel

@{
    ViewData["Title"] = "Thông tin cá nhân";
}

<link rel="stylesheet" href="~/css/user/profile.css" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />

<div class="container airbnb-profile py-4">
    <!-- Wrapper chia 2 bên -->
    <div class="d-flex flex-wrap profile-wrapper">
        <!-- Bên trái: Avatar + Nút -->
        <div class="avatar-section">
            <div>
                <img src="@(!string.IsNullOrEmpty(Model.AvatarPath) ? Url.Content(Model.AvatarPath) : Url.Content("~/image/default-avatar.png"))"
                     class="avatar-img" alt="Avatar" />

                <!-- Các nút chuyển xuống dưới avatar -->
                <div class="d-flex flex-column mt-3 gap-2">
                    @if (Model.IsCurrentUser)
                    {
                        <a href="/User/Edit" class="btn btn-outline-primary btn-sm">✏️ Chỉnh sửa hồ sơ</a>
                    }
                    <a href="/User/AllProjectHistory?userId=@Model.UserID" class="btn btn-outline-secondary btn-sm">📜 Lịch sử dự án</a>
                    @if (Model.IsCurrentUser)
                    {
                        <a href="/User/VipSubscription" class="btn btn-warning btn-sm">🚀 Nâng cấp VIP</a>
                    }
                </div>
            </div>
        </div>

        <!-- Bên phải: Nội dung -->
        <div class="content-section">
            <!-- Header -->
            <div class="profile-header">
                <h2 class="fw-bold mb-1">
                    @Model.FullName
                </h2>
                <div class="d-flex align-items-center mb-3">
                    @if (Model.AverageRating.HasValue)
                    {
                        <div class="rating-stars me-3">
                            <i class="fas fa-star text-warning"></i>
                            <span>@Model.AverageRating.Value.ToString("0.0")</span>
                        </div>
                    }
                    @if (Model.IsVerified)
                    {
                        <div class="verified-badge" style="background-color: #4299e1; display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 6px; font-size: 0.9rem;">
                            <i class="fas fa-check-circle" style="color: white !important; margin-right: 6px;"></i>
                            <span style="color: white !important; font-weight: bold;">Verified</span>
                        </div>
                    }
                </div>
            </div>

            <!-- Thông tin cá nhân -->
            <div class="profile-info-box mt-4">
                <div class="section-title">🧾 Thông tin cá nhân</div>

                <div class="info-row"><div class="info-label">Số điện thoại:</div><div class="info-value">@Model.PhoneNumber</div></div>

                @if (Model.RoleId == 4)
                {
                    <div class="info-row"><div class="info-label">Trường đại học:</div><div class="info-value">@Model.University</div></div>
                    <div class="info-row"><div class="info-label">Chuyên ngành:</div><div class="info-value">@Model.Major</div></div>
                }
                else if (Model.RoleId == 3)
                {
                    <div class="info-row"><div class="info-label">Công ty:</div><div class="info-value">@Model.CompanyName</div></div>
                    <div class="info-row"><div class="info-label">Ngành nghề:</div><div class="info-value">@Model.Industry</div></div>
                }

                <div class="info-row">
                    <div class="info-label">Địa chỉ:</div>
                    @{
                        var addressParts = new[] { Model.DetailAddress, Model.WardName, Model.DistrictName, Model.ProvinceName };
                        var fullAddress = string.Join(", ", addressParts.Where(p => !string.IsNullOrWhiteSpace(p)));
                    }
                    <div class="info-value">@fullAddress</div>
                </div>
            </div>

            <!-- Đánh giá trung bình -->
            <div class="profile-info-box">
                <div class="section-title">Đánh giá</div>
                @if (Model.AverageRating.HasValue)
                {
                    var rating = Model.AverageRating.Value;
                    <div class="average-rating mb-2">
                        <div class="star-rating">
                            @for (int i = 1; i <= 5; i++)
                            {
                                if (i <= Math.Floor(rating))
                                {
                                    <i class="fas fa-star filled"></i>
                                }
                                else if (i - rating < 1)
                                {
                                    <i class="fas fa-star-half-alt filled"></i>
                                }
                                else
                                {
                                    <i class="far fa-star"></i>
                                }
                            }
                        </div>
                        <span class="rating-number">(@rating.ToString("0.0"))</span>
                    </div>
                }
                else
                {
                    <div class="text-muted mb-2">Chưa có đánh giá</div>
                }
            </div>

            <!-- Đánh giá gần đây -->
            @if (Model.ReceivedRatings?.Any() == true)
            {
                <div class="profile-info-box">
                    <div class="section-title">⭐ Đánh giá gần đây</div>

                    @foreach (var rating in Model.ReceivedRatings.Take(3))
                    {
                        <div class="rating-card d-flex">
                            <img src="@Url.Content(!string.IsNullOrEmpty(rating.ReviewerAvatarPath) ? rating.ReviewerAvatarPath : "~/image/default-avatar.png")"
                                 class="rating-avatar-img me-3"
                                 style="width:48px; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 50%;"
                                 alt="Reviewer Avatar"
                                 onerror="this.onerror=null;this.src='@Url.Content("~/image/default-avatar.png")';" />

                            <div>
                                <div class="rating-header fw-bold">@rating.ReviewerName</div>
                                <div class="star-rating mb-1">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if (i <= rating.Score)
                                        {
                                            <i class="fas fa-star filled"></i>
                                        }
                                        else
                                        {
                                            <i class="far fa-star"></i>
                                        }
                                    }
                                </div>
                                <div>@rating.Comment</div>
                                <div class="text-muted small">@rating.DateRated.ToString("dd/MM/yyyy")</div>
                            </div>
                        </div>
                    }

                    <a href="/User/AllReviews?userId=@Model.UserID" class="btn btn-sm btn-outline-info">🔍 Xem tất cả đánh giá</a>
                </div>
            }

            <!-- Kỹ năng -->
            @if (Model.RoleId != 3)
            {
                <div class="profile-info-box">
                    <div class="section-title">Kỹ năng</div>

                    @if (Model.Skills.Any())
                    {
                        <div class="skill-list">
                            @foreach (var skill in Model.Skills)
                            {
                                <span class="skill-tag">@skill.SkillName (@skill.ProficiencyLevelName)</span>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">Chưa cập nhật kỹ năng.</p>
                    }
                </div>
            }
        </div>
    </div>
</div>
