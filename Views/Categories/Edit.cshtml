@model StudentFreelance.Models.Category
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    ViewData["Title"] = "Chỉnh sửa danh mục";
    bool isParent = ViewBag.IsParent as bool? ?? false;
    bool isChild = ViewBag.IsChild as bool? ?? false;
    bool isEditable = isChild; // chỉ được sửa CategoryType khi là skill

    // Danh sách cho CategoryType
    var typeItems = new List<SelectListItem> {
        new SelectListItem("Field", "field"),
        new SelectListItem("Skill", "skill")
    };
    // Danh sách cho ParentCategoryID
    var parentItems = ViewData["ParentCategoryID"] as List<SelectListItem> ?? new List<SelectListItem>();
}

<h2>@ViewData["Title"]</h2>

<form asp-action="Edit" method="post">
    @* Bắt buộc confirm để lưu *@
    <input type="hidden" name="confirm" value="yes" />
    <input asp-for="CategoryID" type="hidden" />

    <div class="form-group">
        <label asp-for="CategoryName" class="control-label"></label>
        @if (isParent)
        {
            <p class="form-control-plaintext">@Model.CategoryName</p>
            <input asp-for="CategoryName" type="hidden" />
        }
        else
        {
            <input asp-for="CategoryName" class="form-control" />
        }
        <span asp-validation-for="CategoryName" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="CategoryType" class="control-label"></label>
        @if (!isEditable)
        {
            <p class="form-control-plaintext" id="categoryTypeSelect">@Model.CategoryType</p>
            <input asp-for="CategoryType" type="hidden" />
        }
        else
        {
            <select asp-for="CategoryType" asp-items="typeItems" class="form-control" id="categoryTypeSelect"></select>
        }
        <span asp-validation-for="CategoryType" class="text-danger"></span>
    </div>

    <div class="form-group" id="parentCategoryGroup">
        <label asp-for="ParentCategoryID" class="control-label">Danh mục cha</label>
        @if (isParent || Model.CategoryType == "field")
        {
            <p class="form-control-plaintext" id="parentSelect">
                @(parentItems.FirstOrDefault(x => x.Value == Model.ParentCategoryID?.ToString())?.Text ?? "-")
            </p>
            <input asp-for="ParentCategoryID" type="hidden" />
        }
        else
        {
            <select asp-for="ParentCategoryID" asp-items="parentItems" class="form-control" id="parentSelect"></select>
        }
        <span asp-validation-for="ParentCategoryID" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Description" class="control-label"></label>
        <textarea asp-for="Description" class="form-control"></textarea>
        <span asp-validation-for="Description" class="text-danger"></span>
    </div>

    <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
    <a asp-action="Index" class="btn btn-secondary">Quay về</a>
</form>

@section Scripts {
    <script>
        function toggleParent() {
            var ct = document.getElementById("categoryTypeSelect");
            var group = document.getElementById("parentCategoryGroup");
            if (!ct) return;
            var val = ct.tagName === 'P' ? ct.textContent.trim() : ct.value;
            group.style.display = (val === "skill") ? "block" : "none";
        }
        document.addEventListener("DOMContentLoaded", function() {
            var ct = document.getElementById("categoryTypeSelect");
            if (ct) {
                ct.addEventListener("change", toggleParent);
                toggleParent();
            }
        });
    </script>
}
